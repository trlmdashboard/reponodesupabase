<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Your existing CSS remains the same */
    </style>
</head>
<body>
    <!-- Your existing HTML remains the same -->

    <script>
        // DOM Elements
        const messageEl = document.getElementById('message');
        const loginForm = document.getElementById('login-form');
        const loginContainer = document.getElementById('login-container');
        const dashboard = document.getElementById('dashboard');
        const welcomeText = document.getElementById('welcome-text');
        const signoutBtn = document.getElementById('signout-btn');
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        
        // Password toggle functionality
        document.getElementById('login-password-toggle').addEventListener('click', function() {
            const input = document.getElementById('login-password');
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
        
        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearMessage();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // Show loading state
            setButtonLoading('login', true);
            
            try {
                // Call our server-side API for authentication
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server returned unexpected response: ${text.substring(0, 100)}`);
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `Login failed with status ${response.status}`);
                }
                
                showMessage('Login successful!', 'success');
                showDashboard(data.user);
            } catch (error) {
                console.error('Login error:', error);
                showMessage(error.message, 'error');
            } finally {
                setButtonLoading('login', false);
            }
        });
        
        // Sign out
        signoutBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server returned unexpected response: ${text.substring(0, 100)}`);
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Logout failed');
                }
                
                dashboard.style.display = 'none';
                loginContainer.style.display = 'block';
                
                showMessage('You have been signed out', 'success');
                
            } catch (error) {
                console.error('Logout error:', error);
                showMessage(error.message, 'error');
            }
        });
        
        // Navigation menu click handler
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                // Update active navigation item
                navItems.forEach(navItem => navItem.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding page
                const pageId = this.getAttribute('data-page');
                pages.forEach(page => {
                    page.classList.remove('active');
                    if (page.id === pageId) {
                        page.classList.add('active');
                    }
                });
            });
        });
        
        // Check if user is already logged in
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/session');
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('Session endpoint returned non-JSON response');
                    return;
                }
                
                const data = await response.json();
                
                if (response.ok && data.user) {
                    showDashboard(data.user);
                }
            } catch (error) {
                console.error('Error checking auth:', error);
            }
        }
        
        // Show dashboard
        function showDashboard(user) {
            const username = user.email.split('@')[0];
            welcomeText.textContent = `Welcome, ${username}`;
            dashboard.style.display = 'flex';
            loginContainer.style.display = 'none';
        }
        
        // Show message
        function showMessage(message, type) {
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                clearMessage();
            }, 5000);
        }
        
        // Clear message
        function clearMessage() {
            messageEl.textContent = '';
            messageEl.className = 'message';
        }
        
        // Set button loading state
        function setButtonLoading(buttonType, isLoading) {
            const textEl = document.getElementById(`${buttonType}-text`);
            const spinnerEl = document.getElementById(`${buttonType}-spinner`);
            const buttonEl = document.getElementById(`${buttonType}-btn`);
            
            if (isLoading) {
                textEl.style.display = 'none';
                spinnerEl.style.display = 'inline-block';
                buttonEl.disabled = true;
            } else {
                textEl.style.display = 'inline-block';
                spinnerEl.style.display = 'none';
                buttonEl.disabled = false;
            }
        }
        
        // Initialize
        checkAuth();
    </script>
</body>
</html>
